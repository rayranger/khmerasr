{% extends 'base.html' %}
{% block title %}
Task Detail
{% endblock %}
{% block content %}
<div class="min-h-screen px-10 py-5 text-gray-700">
    <div class="flex flex-col space-y-10 item-start">
        <!-- Back btn here -->
        <div>
            <a href="{{url_for('task_page')}}">
                <div class="flex flex-row space-x-3 px-5 py-3 text-blue-500 shadow-md max-w-max">
                    <div>
                        <i class="fa-solid fa-circle-left"></i>
                    </div>
                    <div>
                        Back to all tasks
                    </div>
                </div>
            </a>
        </div>
        <div class="px-10 w-full" id="task_detail_model">
            <div class="flex flex-col space-y-10">
                <!-- Title here -->
                <div class="flex flex-col space-y-3">
                    <div class="text-xl">
                        <p>{{selected_task.name}}</p>
                    </div>
                    <div>
                        <div class="flex flex-row items-center justify-between">
                            <div class="text-3xl font-bold">
                                <p>Recording {{recording.id}}</p>
                            </div>
                            <div class="flex flex-row space-x-3 items-center px-3 py-2 border border-blue-500 rounded-md">
                                <div>
                                    <p>Completed</p>
                                </div>
                                <div class="px-3 text-white bg-blue-500 rounded-md">
                                    <p>1 / 10</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="w-1/4 border">
                        <hr>
                    </div>
                </div>
                <!-- Info here -->
                <div class="flex flex-col">
                    <div class="bg-gray-700 text-white py-2 px-6 rounded-tl-md rounded-tr-md max-w-max">
                        <div class="flex flex-row space-x-3 uppercase">
                            <div>
                                <i class="fa-solid fa-circle-info"></i>
                            </div>
                            <div>
                                information
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-300 rounded-md rounded-tl-none p-3">
                        <div class="flex flex-row item-center justify-center space-x-5 border border-gray-700 border-dashed rounded-md p-3">
                            <div class="w-1/2">
                                <div class="flex flex-col space-y-3 w-full items-start">
                                    <div class="font-bold uppercase">
                                        instruction
                                    </div>
                                    <div class="self-center px-10">
                                        {{recording.instruction}}
                                    </div>
                                </div>
                            </div>
                            <div class="w-1/2 border-l pl-5 border-gray-700 border-dotted">
                                <div class="flex flex-col space-y-3 w-full items-start">
                                    <div class="font-bold uppercase">
                                        <div class="flex flex-row space-x-3 items-center">
                                            <div>
                                                transcript
                                            </div>
                                            <div>
                                                <i class="fa-solid fa-music"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="self-center px-10">
                                        {{recording.transcript}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- action here -->
        <div class="px-10">
            <div class="flex flex-row space-x-5 items-center justify-center">
                <div class="bg-orange-500 px-4 py-1 text-white rounded-md">
                    <div class="flex flex-row space-x-3 item-center">
                        <div>
                            <i class="fa-solid fa-angles-left"></i>
                        </div>
                        <div>
                            Previous
                        </div>
                    </div>
                </div>
                <div id="mic_btn" class=" cursor-pointer border border-red-500 px-4 py-1 text-red-500 rounded-md">
                    <div class="flex flex-row space-x-3 item-center">
                        <div id="mic_btn_icon">
                            <i class="fa-solid fa-microphone"></i>
                        </div>
                        <div id="mic_btn_text">
                            Record
                        </div>
                    </div>
                </div>
                <div>
                    <audio src="" controls class="rounded-md" id="preview_audio"></audio>
                </div>
                <div class="border border-green-600 text-green-600 px-4 py-1 rounded-md">
                    <div class="flex flex-row space-x-3 item-center">
                        <div>
                            <i class="fa-solid fa-floppy-disk"></i>
                        </div>
                        <div>
                            Save
                        </div>
                    </div>
                </div>
                <div class="bg-green-600 px-4 py-1 text-white rounded-md cursor-pointer" id="next_btn">
                    <div class="flex flex-row space-x-3 item-center">
                        <div>
                            Save & Next
                        </div>
                        <div>
                            <i class="fa-solid fa-angles-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div> 
    </div>

</div>
<script>
    url_param = "{{selected_task.id}}"
    const SAMPLE_RATE = "{{recording_config.sample_rate}}"
    const SAMPLE_SIZE = "{{recording_config.number_of_sample}}"
    const CHANNEL_COUNT = "{{recording_config.channel}}"
    console.log(`${SAMPLE_RATE}, ${SAMPLE_SIZE}, ${CHANNEL_COUNT}`)
    preview_audio = document.getElementById('preview_audio')
    next_btn = document.getElementById('next_btn')
    mic_btn_icon = document.getElementById('mic_btn_icon')
    mic_btn_text = document.getElementById('mic_btn_text')

    mic_btn = document.getElementById('mic_btn')

    flag = 0

    mic_btn.addEventListener('click', ()=>{
        console.log(flag)
        if (flag==0){
            mic_btn.classList.remove('text-red-500')

            mic_btn.classList.add('bg-red-500')
            mic_btn.classList.add('text-white')

            mic_btn_icon.innerHTML = '<i class="fa-solid fa-stop"></i>'
            mic_btn_text.innerHTML = 'Stop'

            flag = 1
        } else {
            mic_btn.classList.remove('bg-red-500')
            mic_btn.classList.remove('text-white')

            mic_btn.classList.add('bg-white')
            mic_btn.classList.add('text-red-500')

            mic_btn_icon.innerHTML = '<i class="fa-solid fa-microphone"></i>'
            mic_btn_text.innerHTML = 'Record'

            flag = 0
        }
        console.log(flag)

    })

    let audioFile = new Blob()

    let constraintObj = {
        audio: {
            sampleSize: SAMPLE_SIZE,
            volume: 1,
            noiseSuppression: true,
            channelCount: CHANNEL_COUNT,
            sampleRate: 46000,
        },
        video: false,
    };

    console.log(constraintObj)
    navigator.mediaDevices.getUserMedia(constraintObj)
        .then(function (mediaStreamObj) {
            let mediaRecorder = new MediaRecorder(mediaStreamObj)
            let chunks = []

            mic_btn.addEventListener('click', (ev) => {
                if (flag == 1){
                    mediaRecorder.start();
                    console.log(mediaRecorder.state);
                }else{
                    mediaRecorder.stop();
                    console.log(mediaRecorder.state);
                }
            })
            mediaRecorder.ondataavailable = function (ev) {
                chunks.push(ev.data);
            }
            mediaRecorder.onstop = (ev) => {
                audioFile = new Blob(chunks,{"type":"audio/{{recording_config.filetype}};"});
                let audioURL = URL.createObjectURL(audioFile);
                preview_audio.src = audioURL
                chunks = []
            }
        })
        .catch(function (err) {
            alert(err.message);
        });

    next_btn.addEventListener('click', () => {
        const timeElapsed = Date.now()
        const today = new Date(timeElapsed)
        let json_filename = ''
        let data = new FormData()
        username = "{{current_user.username}}"
        filetype = "{{recording_config.filetype}}"
        filename = `${username}_${today.toISOString()}_.${filetype}`
        data.append('audioFile', audioFile, filename)
        fetch(`http://127.0.0.1:5000/save-audio`, {
            method: 'POST',
            body: data
        }).then(response => response.json()).then(json => {
            json_filename = json
            console.log(json_filename)
            $.ajax({
            url:'/recording',
            data:{id:url_param, filename:json_filename},
            dataType: 'json',
            async: true,
            processData: true,
            type: 'GET',
            success: (result)=>{
                $(task_detail_model).replaceWith(result)
                console.log(result)
            }
        })
        })
        audioFile = new Blob()
    })

</script>
{% endblock %}